{% extends 'index.html' %}
{% load static i18n %}

{% block content %}
<link rel="stylesheet" href="{% static 'payroll/css/keka_payslips.css' %}?v=1.0">

<div class="payslip-container">

    <!-- Header Section -->
    <div class="payslip-header">
        <div class="payslip-header-left">
            <h1>{% trans "My Payslips" %}</h1>
            <p>{% trans "View and download your monthly salary slips and financial information" %}</p>
        </div>

        {% if bank_details or work_info %}
        <!-- Bank Details Card -->
        <div class="bank-details-card">
            <h3>{% trans "Financial Information" %}</h3>
            <div class="bank-info-grid">
                {% if bank_details %}
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "Bank Name" %}</div>
                    <div class="bank-info-value">{{ bank_details.bank_name|default:"Not Set" }}</div>
                </div>
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "Account Number" %}</div>
                    <div class="bank-info-value">
                        {% if bank_details.account_number %}
                        ****{{ bank_details.account_number|slice:"-4:" }}
                        {% else %}
                        Not Set
                        {% endif %}
                    </div>
                </div>
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "IFSC Code" %}</div>
                    <div class="bank-info-value">{{ bank_details.any_other_code1|default:"Not Set" }}</div>
                </div>
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "Branch" %}</div>
                    <div class="bank-info-value">{{ bank_details.branch|default:"Not Set" }}</div>
                </div>
                {% endif %}

                {% if work_info %}
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "UAN Number" %}</div>
                    <div class="bank-info-value">{{ work_info.uan_number|default:"Not Set" }}</div>
                </div>
                <div class="bank-info-item">
                    <div class="bank-info-label">{% trans "Annual CTC" %}</div>
                    <div class="bank-info-value">
                        {% if work_info.basic_salary %}
                        â‚¹{{ work_info.basic_salary|floatformat:0 }}
                        {% else %}
                        Not Set
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Upload Button for Admin -->
    {% if perms.payroll.add_employeepayslip %}
    <div style="margin-bottom: 30px;">
        <a href="{% url 'upload-payslip' %}" class="btn-download">
            <i class="ion-upload"></i> {% trans "Upload Payslip" %}
        </a>
    </div>
    {% endif %}

    <!-- Payslips Section -->
    <div class="payslips-section">
        <h2 class="payslips-section-title">{% trans "Payslip History" %}</h2>

        <div class="payslips-grid">
            {% for payslip in payslips %}
            <div class="payslip-card" onclick="this.classList.toggle('expanded')">
                <div class="payslip-card-header">
                    <div class="payslip-card-title">
                        <div class="payslip-icon">
                            <i class="ion-document-text"></i>
                        </div>
                        <div class="payslip-meta">
                            <h4>
                                {% if perms.payroll.add_employeepayslip %}
                                {{ payslip.employee }}
                                {% else %}
                                {% trans "Salary Slip" %}
                                {% endif %}
                            </h4>
                            <p>{{ payslip.pay_period|date:"F Y" }}</p>
                        </div>
                    </div>
                    <div class="payslip-actions">
                        <span class="payslip-badge">
                            {{ payslip.uploaded_at|date:"M d, Y" }}
                        </span>
                        <a href="{{ payslip.document.url }}" class="btn-download" onclick="event.stopPropagation()"
                            target="_blank" download>
                            <i class="ion-ios-download"></i> {% trans "Download" %}
                        </a>
                        {% if perms.payroll.delete_employeepayslip %}
                        <a href="{% url 'delete-payslip' payslip.id %}" class="btn-delete"
                            onclick="event.stopPropagation(); return confirm('{% trans " Are you sure you want to delete
                            this payslip?" %}')">
                            <i class="ion-trash-a"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Expanded Details -->
                <div class="payslip-details">
                    <div class="payslip-details-grid">
                        <div class="detail-item">
                            <div class="detail-label">{% trans "Pay Period" %}</div>
                            <div class="detail-value">{{ payslip.pay_period|date:"F Y" }}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">{% trans "Uploaded On" %}</div>
                            <div class="detail-value">{{ payslip.uploaded_at|date:"M d, Y" }}</div>
                        </div>
                        {% if perms.payroll.add_employeepayslip %}
                        <div class="detail-item">
                            <div class="detail-label">{% trans "Employee" %}</div>
                            <div class="detail-value">{{ payslip.employee }}</div>
                        </div>
                        {% endif %}
                        <div class="detail-item">
                            <div class="detail-label">{% trans "Document" %}</div>
                            <div class="detail-value">
                                <a href="{{ payslip.document.url }}" target="_blank"
                                    style="color: var(--primary); text-decoration: none;">
                                    <i class="ion-link"></i> {% trans "View PDF" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="ion-ios-filing-outline"></i>
                </div>
                <h3>{% trans "No Payslips Found" %}</h3>
                <p>{% trans "Your payslips will appear here once they are uploaded by HR." %}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination -->
    {% if payslips.has_other_pages %}
    <div class="pagination-wrapper">
        {% if payslips.has_previous %}
        <a href="?page={{ payslips.previous_page_number }}" class="pagination-btn">
            <i class="ion-chevron-left"></i> {% trans "Previous" %}
        </a>
        {% endif %}

        <span class="pagination-info">
            {% trans "Page" %} {{ payslips.number }} {% trans "of" %} {{ payslips.paginator.num_pages }}
        </span>

        {% if payslips.has_next %}
        <a href="?page={{ payslips.next_page_number }}" class="pagination-btn">
            {% trans "Next" %} <i class="ion-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}

</div>

<script>
    // Enhanced toggle for payslip cards
    document.querySelectorAll('.payslip-card').forEach(card => {
        card.addEventListener('click', function (e) {
            // Don't toggle if clicking on links or buttons
            if (e.target.closest('a') || e.target.closest('button')) {
                return;
            }
            this.classList.toggle('expanded');
        });
    });
</script>

{% endblock %}