{% load static %}
{% load i18n %}

<link rel="stylesheet" href="{% static 'employee/css/keka_hierarchy.css' %}">

<div class="team-hierarchy-container">
    <div class="hierarchy-tree">

        <!-- Level 1: Reporting Manager -->
        {% if hierarchy_data.reporting_manager %}
        <div class="hierarchy-node level-manager">
            <div class="level-label">{% trans "Reporting To" %}</div>
            <div class="org-card-wrapper">
                <div class="keka-card"
                    onclick="window.location.href='{% url 'employee-view-individual' hierarchy_data.reporting_manager.id %}'">
                    <span class="role-badge">Manager</span>
                    <div
                        class="status-dot {% if hierarchy_data.reporting_manager.check_online %}online{% else %}offline{% endif %}">
                    </div>

                    {% if hierarchy_data.reporting_manager.employee_profile %}
                    <img src="{{ hierarchy_data.reporting_manager.get_avatar }}"
                        alt="{{ hierarchy_data.reporting_manager.get_full_name }}" class="card-avatar">
                    {% else %}
                    <div class="card-avatar"
                        style="background: #e2e8f0; display:flex; align-items:center; justify-content:center;">
                        <ion-icon name="person" style="font-size:2rem; color:#a0aec0;"></ion-icon>
                    </div>
                    {% endif %}

                    <h3 class="card-name">{{ hierarchy_data.reporting_manager.get_full_name }}</h3>
                    <p class="card-role">{{ hierarchy_data.reporting_manager.get_job_position|default:"Manager" }}</p>

                    <div class="card-actions">
                        <a href="mailto:{{ hierarchy_data.reporting_manager.get_mail }}" class="action-icon"
                            title="Email">
                            <ion-icon name="mail-outline"></ion-icon>
                        </a>
                        <a href="tel:{{ hierarchy_data.reporting_manager.phone }}" class="action-icon" title="Call">
                            <ion-icon name="call-outline"></ion-icon>
                        </a>
                        <a href="{% url 'employee-view-individual' hierarchy_data.reporting_manager.id %}"
                            class="action-icon" title="View Profile">
                            <ion-icon name="arrow-forward-outline"></ion-icon>
                        </a>
                    </div>
                </div>
            </div>
            <!-- Vertical Line Down to You -->
            <div class="connector-line-vertical"></div>
        </div>
        {% endif %}

        <!-- Level 2: YOU -->
        <div class="hierarchy-node level-you">
            <div class="level-label">{% trans "You" %}</div>
            <div class="org-card-wrapper">
                <div class="keka-card is-you" onclick="window.location.href='{% url 'employee-profile' %}'">
                    <span class="role-badge">Me</span>
                    <div class="status-dot online"></div>

                    {% if hierarchy_data.employee.employee_profile %}
                    <img src="{{ hierarchy_data.employee.get_avatar }}"
                        alt="{{ hierarchy_data.employee.get_full_name }}" class="card-avatar">
                    {% else %}
                    <div class="card-avatar"
                        style="background: #e2e8f0; display:flex; align-items:center; justify-content:center;">
                        <ion-icon name="person" style="font-size:2rem; color:#a0aec0;"></ion-icon>
                    </div>
                    {% endif %}

                    <h3 class="card-name">{{ hierarchy_data.employee.get_full_name }}</h3>
                    <p class="card-role">{{ hierarchy_data.employee.get_job_position|default:"Employee" }}</p>

                    <div class="card-actions">
                        <a href="mailto:{{ hierarchy_data.employee.get_mail }}" class="action-icon" title="Email">
                            <ion-icon name="mail-outline"></ion-icon>
                        </a>
                        <a href="{% url 'employee-profile' %}" class="action-icon" title="Edit Profile">
                            <ion-icon name="create-outline"></ion-icon>
                        </a>
                    </div>
                </div>
            </div>

            {% if hierarchy_data.peers or hierarchy_data.reportees %}
            <!-- Vertical Line Down from You to split point if there are sub-levels -->
            <div class="connector-line-vertical" style="height: 2rem;"></div>
            {% endif %}
        </div>

        <!-- Level 3 Container -->
        {% if hierarchy_data.peers or hierarchy_data.reportees %}
        <div style="display:flex; gap:4rem; width:100%; justify-content:center; align-items:flex-start;">

            <!-- Peers Branch -->
            {% if hierarchy_data.peers %}
            <div class="hierarchy-node level-peers" style="flex:1;">
                <div class="level-label"
                    style="top: -1.5rem; left: 50%; transform: translateX(-50%); width:max-content;">{% trans "Team
                    Peers" %}</div>
                <!-- Bridge for Peers -->
                <div class="node-group">
                    {% for peer in hierarchy_data.peers %}
                    <div class="org-card-wrapper">
                        <div class="keka-card"
                            onclick="window.location.href='{% url 'employee-view-individual' peer.id %}'">
                            <div class="status-dot {% if peer.check_online %}online{% else %}offline{% endif %}"></div>

                            {% if peer.employee_profile %}
                            <img src="{{ peer.get_avatar }}" alt="{{ peer.get_full_name }}" class="card-avatar">
                            {% else %}
                            <div class="card-avatar"
                                style="background: #e2e8f0; display:flex; align-items:center; justify-content:center;">
                                <ion-icon name="person" style="font-size:2rem; color:#a0aec0;"></ion-icon>
                            </div>
                            {% endif %}

                            <h3 class="card-name">{{ peer.get_full_name }}</h3>
                            <p class="card-role">{{ peer.get_job_position|default:"Peer" }}</p>

                            <div class="card-actions">
                                <a href="mailto:{{ peer.get_mail }}" class="action-icon" title="Email">
                                    <ion-icon name="mail-outline"></ion-icon>
                                </a>
                                <a href="{% url 'employee-view-individual' peer.id %}" class="action-icon"
                                    title="View Profile">
                                    <ion-icon name="arrow-forward-outline"></ion-icon>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Reportees Branch -->
            {% if hierarchy_data.reportees %}
            <div class="hierarchy-node level-reportees" style="flex:1;">
                <div class="level-label"
                    style="top: -1.5rem; left: 50%; transform: translateX(-50%); width:max-content;">{% trans "Direct
                    Reports" %}</div>
                <!-- Bridge for Reportees -->
                <div class="node-group">
                    {% for reportee in hierarchy_data.reportees %}
                    <div class="org-card-wrapper">
                        <div class="keka-card"
                            onclick="window.location.href='{% url 'employee-view-individual' reportee.id %}'">
                            <div class="status-dot {% if reportee.check_online %}online{% else %}offline{% endif %}">
                            </div>

                            {% if reportee.employee_profile %}
                            <img src="{{ reportee.get_avatar }}" alt="{{ reportee.get_full_name }}" class="card-avatar">
                            {% else %}
                            <div class="card-avatar"
                                style="background: #e2e8f0; display:flex; align-items:center; justify-content:center;">
                                <ion-icon name="person" style="font-size:2rem; color:#a0aec0;"></ion-icon>
                            </div>
                            {% endif %}

                            <h3 class="card-name">{{ reportee.get_full_name }}</h3>
                            <p class="card-role">{{ reportee.get_job_position|default:"Reportee" }}</p>

                            <div class="card-actions">
                                <a href="mailto:{{ reportee.get_mail }}" class="action-icon" title="Email">
                                    <ion-icon name="mail-outline"></ion-icon>
                                </a>
                                <a href="{% url 'employee-view-individual' reportee.id %}" class="action-icon"
                                    title="View Profile">
                                    <ion-icon name="arrow-forward-outline"></ion-icon>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not hierarchy_data.reporting_manager and not hierarchy_data.peers and not hierarchy_data.reportees %}
        <div style="text-align:center; padding: 4rem; width: 100%;">
            <ion-icon name="git-network-outline"
                style="font-size: 4rem; color: var(--keka-subtext); opacity:0.5;"></ion-icon>
            <h3 style="margin-top:1rem; color:var(--keka-text);">{% trans "No Hierarchy Found" %}</h3>
            <p style="color:var(--keka-subtext);">{% trans "Your position in the organization chart has not been defined
                yet." %}</p>
        </div>
        {% endif %}

    </div>
</div>

<script>
    // Initialize standard interactions via JS
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.keka-card');
        cards.forEach(card => {
            card.addEventListener('mouseenter', () => {
                // Potential future animations
            });
        });
    });
</script>