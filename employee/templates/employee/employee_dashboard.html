{% extends 'index.html' %}
{% load i18n static basefilters horillafilters %}

{% block content %}
<link rel="stylesheet" href="{% static 'employee/css/keka_exact.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /* Map View Styles */
    #mapModal .modal-dialog {
        max_width: 90%;
        height: 90vh;
        margin: 20px auto;
    }

    #mapModal .modal-content {
        height: 100%;
        border-radius: 0;
    }

    #mapModal .modal-body {
        padding: 0;
        height: calc(100% - 60px);
        /* minus header */
    }

    .map-sidebar {
        height: 100%;
        overflow-y: auto;
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        padding: 20px;
    }

    .map-container {
        height: 100%;
        width: 100%;
    }

    .timeline-item {
        position: relative;
        padding-left: 30px;
        margin-bottom: 20px;
        border-left: 2px solid #e9ecef;
    }

    .timeline-marker {
        position: absolute;
        left: -11px;
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        text-align: center;
        font-size: 10px;
        line-height: 20px;
        font-weight: bold;
    }

    .timeline-title {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .timeline-time {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .timeline-coords {
        font-size: 0.7rem;
        color: #adb5bd;
    }
</style>
<div class="keka-theme">
    <div class="oh-wrapper">
        <!-- Theme Toggle -->
        <div class="d-flex justify-content-end mb-2 pt-3 pe-3">
            <button class="btn btn-light rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                id="themeToggle"
                style="width:40px;height:40px; border: 1px solid var(--keka-border); background: var(--keka-card-bg);">
                <ion-icon name="sunny-outline" id="themeIcon"
                    style="font-size: 1.2rem; color: var(--keka-text);"></ion-icon>
            </button>
        </div>

        <!-- Top Panel: 3 Columns -->
        <div class="row mt-4 mb-4">

            <!-- 1. Stats Panel -->
            <div class="col-md-4 mb-3">
                <div class="keka-card">
                    <div class="keka-header d-flex justify-content-between">
                        <span>Attendance Stats</span>
                        <div class="dropdown">
                            <span class="text-primary" style="cursor:pointer; font-size:0.8rem;">This Week â–¼</span>
                        </div>
                    </div>
                    <div class="body">
                        <!-- Me Row -->
                        <div class="stats-row">
                            <div class="stats-label">
                                <div class="stats-icon"><ion-icon name="person"></ion-icon></div>
                                <div>
                                    <div class="stats-value">Me</div>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="stats-sub">AVG HRS / DAY</div>
                                <div class="stats-value">{{ avg_hours|default:"05:46" }}hrs</div>
                            </div>
                            <div class="text-end">
                                <div class="stats-sub">ON TIME</div>
                                <div class="stats-value text-success">{{ on_time_pct|default:"98" }}%</div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- 2. Timings Panel -->
            <div class="col-md-4 mb-3">
                <div class="keka-card">
                    <div class="keka-header">Timings</div>
                    <div class="week-circles">
                        <div class="day-circle {% if day_index == 6 %}active{% endif %}">S</div>
                        <div class="day-circle {% if day_index == 0 %}active{% endif %}">M</div>
                        <div class="day-circle {% if day_index == 1 %}active{% endif %}">T</div>
                        <div class="day-circle {% if day_index == 2 %}active{% endif %}">W</div>
                        <div class="day-circle {% if day_index == 3 %}active{% endif %}">T</div>
                        <div class="day-circle {% if day_index == 4 %}active{% endif %}">F</div>
                        <div class="day-circle {% if day_index == 5 %}active{% endif %}">S</div>
                    </div>
                    <div class="mt-3">
                        <div class="shift-progress">
                            <div class="shift-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div class="d-flex justify-content-between text-muted mb-3" style="font-size: 0.8rem;">
                            <span>Duration: 9:00 hrs</span>
                        </div>

                        <div style="font-size: 0.75rem; color: #666; line-height: 1.8;">
                            <div class="d-flex justify-content-between border-bottom pb-1 mb-1">
                                <span style="font-weight:500;">Morning Break :</span>
                                <span>15mins from 10:45 to 11:00</span>
                            </div>
                            <div class="d-flex justify-content-between border-bottom pb-1 mb-1">
                                <span style="font-weight:500;">Lunch Break :</span>
                                <span>45min from 1:00 to 1:45</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span style="font-weight:500;">Evening Break :</span>
                                <span>15mins from 4:00 to 4:30</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Actions Panel -->
            <div class="col-md-4 mb-3">
                <div class="keka-card text-center d-flex flex-column justify-content-center">
                    <div class="text-start mb-2" style="font-size:0.9rem; color:#777;">Actions</div>
                    <div class="row align-items-center">
                        <div class="col-7 text-start">
                            <div class="clock-display" id="liveTimer" data-start-time="{{ last_in_time|default:'' }}">
                                00:00:00</div>
                            <div class="date-display" id="liveDate">{{ current_date|date:"D d, M Y" }}</div>
                        </div>
                        <div class="col-5">
                            {% csrf_token %}
                            {% if last_attendance_action == 'in' %}
                            <button id="clockBtn" class="btn-keka-clock" style="background:#f44336;">Clock Out</button>
                            {% else %}
                            <button id="clockBtn" class="btn-keka-clock">Web Clock-In</button>
                            {% endif %}
                            <div style="font-size:0.75rem; text-align:right;">
                                <a href="#" class="d-block" id="remoteClockInBtn">Remote Clock-in</a>
                            </div>
                        </div>
                    </div>
                    <div class="mt-auto text-start pt-3 border-top">
                        <a href="#" style="font-size:0.85rem;">Attendance Policy</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Panel: Logs Table -->
        <div class="row">
            <div class="col-12">
                <div class="keka-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <!-- FIXED TAG -->
                            <span style="font-size:0.9rem; color:#555;">Current Status: <strong>
                                    {% if last_attendance_action == 'in' %}
                                    In Office
                                    {% else %}
                                    Checked Out
                                    {% endif %}
                                </strong></span>
                        </div>
                        <div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-primary">30 Days</button>
                                <button class="btn btn-light border">Jun</button>
                                <button class="btn btn-light border">May</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th style="width:30%;">Attendance Visual</th>
                                    <th>Effective Hours</th>
                                    <th>Gross Hours</th>
                                    <th>Arrival</th>
                                    <th>Log</th>
                                </tr>
                            </thead>
                            <tbody id="logsBody">
                                {% for row in attendance_logs %}
                                <tr>
                                    <td>{{ row.date|date:"M d D" }} <span class="pill pill-woff">GEN</span></td>
                                    <td>
                                        <div class="log-visual-track">
                                            <!-- Simple full bar if present, logic can be complex for segments -->
                                            {% if row.first_in %}
                                            <div class="log-visual-bar" style="left: 0%; width: 100%;"></div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td><strong>{{ row.effective_hours }}</strong></td>
                                    <td>{{ row.gross_hours }}</td>
                                    <td>
                                        {% if "Late" in row.arrival %}
                                        <span class="text-danger">{{ row.arrival }}</span>
                                        {% else %}
                                        <span class="text-success">{{ row.arrival }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for log in row.logs %}
                                        <div style="font-size:0.8rem; margin-bottom: 4px;">
                                            {% if log.action == 'in' %}
                                            <ion-icon name="log-in-outline" class="text-success"></ion-icon>
                                            {% else %}
                                            <ion-icon name="log-out-outline" class="text-danger"></ion-icon>
                                            {% endif %}
                                            {{ log.timestamp|date:"h:i A" }}
                                            {% if log.latitude and log.longitude %}
                                            <a href="{% url 'attendance-map-view' %}?date={{ row.date|date:'Y-m-d' }}"
                                                target="_blank" title="View Daily Route">
                                                <small class="text-muted ms-1" style="font-size:0.7rem;">
                                                    <ion-icon name="map-outline"></ion-icon>
                                                </small>
                                            </a>
                                            {% endif %}

                                        </div>
                                        {% empty %}
                                        <span class="text-muted">-</span>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center p-4 text-muted">No logs found for this period.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="{% static 'employee/js/attendance_clock.js' %}"></script>
<!-- FIXED URGENTLY -->
{% endblock content %}