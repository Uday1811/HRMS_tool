{% extends 'index.html' %}
{% load i18n static %}

{% block content %}
<link rel="stylesheet" href="{% static 'employee/css/keka_handbook.css' %}?v=2.0">
<style>
    .section-hidden {
        display: none !important;
    }
</style>

<div class="handbook-container">

    <!-- Header -->
    <div class="handbook-header">
        <h1>{% trans "Employee Handbook" %}</h1>
        <p>Your comprehensive guide to company policies, procedures, and culture. Browse the sections below to
            learn more.</p>
    </div>

    <!-- Edit Mode Banner (Only for HR/Admin) -->
    {% if can_edit %}
    <div class="edit-mode-banner">
        <div class="edit-mode-text">
            <i class="ion-edit"></i>
            <span>{% trans "You have permission to edit handbook sections" %}</span>
        </div>
        <button class="btn-save-all" onclick="saveAllSections()">
            <i class="ion-checkmark-round"></i> {% trans "Save All Changes" %}
        </button>
    </div>
    {% endif %}

    <!-- Tab Navigation -->
    <div class="handbook-tabs">
        <button class="tab-btn active" onclick="switchTab(this, 'company_rules')" data-section="company_rules">
            <i class="ion-briefcase"></i>
            {% trans "Company Rules" %}
        </button>
        <button class="tab-btn" onclick="switchTab(this, 'conduct_guidelines')" data-section="conduct_guidelines">
            <i class="ion-person-stalker"></i>
            {% trans "Conduct" %}
        </button>
        <button class="tab-btn" onclick="switchTab(this, 'dress_code')" data-section="dress_code">
            <i class="ion-ios-body"></i>
            {% trans "Dress Code" %}
        </button>
        <button class="tab-btn" onclick="switchTab(this, 'code_of_ethics')" data-section="code_of_ethics">
            <i class="ion-ribbon-b"></i>
            {% trans "Ethics" %}
        </button>
        <button class="tab-btn" onclick="switchTab(this, 'it_policy')" data-section="it_policy">
            <i class="ion-monitor"></i>
            {% trans "IT Policy" %}
        </button>
    </div>

    <!-- Content Sections -->
    <div id="handbookContent">

        {% for section in sections %}
        <div id="{{ section.section_type }}"
            class="content-section {% if not forloop.first %}section-hidden{% endif %}">
            <div class="section-header">
                <h2>
                    <i class="ion-document-text"></i>
                    {{ section.title }}
                </h2>
                {% if can_edit %}
                <button class="btn-edit" onclick="toggleEdit('{{ section.section_type }}')">
                    <i class="ion-edit"></i> {% trans "Edit Section" %}
                </button>
                {% endif %}
            </div>

            <!-- Display Mode -->
            <div class="section-content" id="content-{{ section.section_type }}">
                {{ section.content|safe }}
            </div>

            <!-- Edit Mode (Only for HR/Admin) -->
            {% if can_edit %}
            <div class="content-editor" id="editor-{{ section.section_type }}">
                <div class="editor-toolbar">
                    <button class="editor-btn" onclick="insertTag('{{ section.section_type }}', 'h3')">
                        <i class="ion-ios-text"></i> Heading
                    </button>
                    <button class="editor-btn" onclick="insertTag('{{ section.section_type }}', 'ul')">
                        <i class="ion-ios-list"></i> List
                    </button>
                    <button class="editor-btn" onclick="insertTag('{{ section.section_type }}', 'p')">
                        <i class="ion-ios-paper"></i> Paragraph
                    </button>
                    <button class="editor-btn" onclick="insertTag('{{ section.section_type }}', 'strong')">
                        <i class="ion-ios-bolt"></i> Bold
                    </button>
                </div>
                <textarea class="editor-textarea"
                    id="textarea-{{ section.section_type }}">{{ section.content }}</textarea>
                <div class="editor-actions">
                    <button class="btn-cancel" onclick="cancelEdit('{{ section.section_type }}')">
                        <i class="ion-close-round"></i> {% trans "Cancel" %}
                    </button>
                    <button class="btn-save" onclick="saveSection('{{ section.section_type }}')">
                        <i class="ion-checkmark-round"></i> {% trans "Save Changes" %}
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="content-section">
            <p style="text-align: center; color: var(--text-muted);">
                {% trans "No handbook sections available. Please contact HR to set up content." %}
            </p>
        </div>
        {% endfor %}

    </div>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<script>
    // Tab Switching - Scoped to handbook container
    function switchTab(btn, sectionId) {
        console.log('Switching to section:', sectionId);

        // Get the handbook container
        const handbookContainer = document.querySelector('.handbook-container');
        if (!handbookContainer) {
            console.error('Handbook container not found!');
            return;
        }

        // Hide all sections within the handbook container only
        handbookContainer.querySelectorAll('.content-section').forEach(el => {
            el.style.display = 'none';
            el.classList.add('section-hidden');
        });

        // Show selected section by setting display to block
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'block';
            section.classList.remove('section-hidden');
            console.log('Showing section:', sectionId);
        } else {
            console.error('Section not found:', sectionId);
        }

        // Update button states within handbook tabs only
        handbookContainer.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
        });
        btn.classList.add('active');
    }

    // Toggle Edit Mode
    function toggleEdit(sectionType) {
        const content = document.getElementById(`content-${sectionType}`);
        const editor = document.getElementById(`editor-${sectionType}`);

        if (content && editor) {
            content.style.display = 'none';
            editor.classList.add('active');
        }
    }

    // Cancel Edit
    function cancelEdit(sectionType) {
        const content = document.getElementById(`content-${sectionType}`);
        const editor = document.getElementById(`editor-${sectionType}`);

        if (content && editor) {
            content.style.display = 'block';
            editor.classList.remove('active');
        }
    }

    // Insert HTML Tag
    function insertTag(sectionType, tag) {
        const textarea = document.getElementById(`textarea-${sectionType}`);
        if (!textarea) return;

        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);

        let insertion = '';
        if (tag === 'ul') {
            insertion = `<ul>\n  <li>${selectedText || 'List item'}</li>\n</ul>`;
        } else if (tag === 'p') {
            insertion = `<p>${selectedText || 'Paragraph text'}</p>`;
        } else if (tag === 'strong') {
            insertion = `<strong>${selectedText || 'Bold text'}</strong>`;
        }

        textarea.value = textarea.value.substring(0, start) + insertion + textarea.value.substring(end);
        textarea.focus();
    }

    // Save Section
    function saveSection(sectionType) {
        const textarea = document.getElementById(`textarea-${sectionType}`);
        if (!textarea) return;

        const content = textarea.value;

        // Show loading
        document.getElementById('loadingOverlay').classList.add('active');

        // Send AJAX request
        fetch(`/employee/edit-handbook-section/${sectionType}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `content=${encodeURIComponent(content)}`
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingOverlay').classList.remove('active');

                if (data.success) {
                    // Update display content
                    document.getElementById(`content-${sectionType}`).innerHTML = content;

                    // Exit edit mode
                    cancelEdit(sectionType);

                    // Show success message
                    alert('{% trans "Section saved successfully!" %}');
                } else {
                    alert('{% trans "Error saving section. Please try again." %}');
                }
            })
            .catch(error => {
                document.getElementById('loadingOverlay').classList.remove('active');
                console.error('Error:', error);
                alert('{% trans "An error occurred. Please try again." %}');
            });
    }

    // Save All Sections
    function saveAllSections() {
        const handbookContainer = document.querySelector('.handbook-container');
        if (!handbookContainer) return;

        const activeSection = handbookContainer.querySelector('.content-section:not([style*="display: none"])');
        if (!activeSection) return;

        const sectionType = activeSection.id;
        const editor = document.getElementById(`editor-${sectionType}`);

        if (editor && editor.classList.contains('active')) {
            saveSection(sectionType);
        } else {
            alert('{% trans "No sections are currently being edited." %}');
        }
    }

    // Initialize - Show first section on page load
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Handbook page loaded, initializing tabs...');

        // Get the handbook container
        const handbookContainer = document.querySelector('.handbook-container');
        if (!handbookContainer) {
            console.error('Handbook container not found!');
            return;
        }

        // Hide all sections first (scoped to handbook container)
        handbookContainer.querySelectorAll('.content-section').forEach(el => {
            el.style.display = 'none';
            el.classList.add('section-hidden');
        });

        // Show first section
        const firstTab = handbookContainer.querySelector('.tab-btn');
        if (firstTab) {
            const firstSectionId = firstTab.getAttribute('data-section');
            const firstSection = document.getElementById(firstSectionId);
            if (firstSection) {
                firstSection.style.display = 'block';
                firstSection.classList.remove('section-hidden');
                console.log('First section shown:', firstSection.id);
            } else {
                console.error('First section not found with ID:', firstSectionId);
            }
        } else {
            console.error('No tabs found!');
        }

        // Log all sections for debugging
        const allSections = handbookContainer.querySelectorAll('.content-section');
        console.log('Total sections found:', allSections.length);
        allSections.forEach(section => {
            console.log('Section ID:', section.id, 'Display:', section.style.display);
        });
    });
</script>

{% endblock %}